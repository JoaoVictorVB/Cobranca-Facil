generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PaymentFrequency {
  quinzenal
  mensal
}

enum PaymentStatus {
  pendente
  pago
  atrasado
  parcial
}

enum RelationshipStatus {
  PENDENTE
  ATIVO
  INATIVO
}

enum TransferStatus {
  ENVIADO
  RECEBIDO
  DEVOLVIDO
  CANCELADO
}

model Client {
  id          String   @id @default(uuid())
  name        String
  phone       String?
  referredBy  String?  @map("referred_by")
  observation String?  @db.Text
  address     String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  sales Sale[]

  @@map("clients")
}

model Category {
  id          String   @id @default(uuid())
  name        String
  description String?
  parentId    String?  @map("parent_id")
  isActive    Boolean  @default(true) @map("is_active")
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@unique([userId, name, parentId])
  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  sku         String? @unique
  categoryId  String? @map("category_id")
  costPrice   Float   @default(0) @map("cost_price")
  salePrice   Float   @default(0) @map("sale_price")
  stock       Int     @default(0)
  minStock    Int     @default(0) @map("min_stock")
  maxStock    Int?    @map("max_stock")
  unit        String  @default("un")
  barcode     String? @unique
  location    String?
  supplier    String?
  notes       String? @db.Text
  isActive    Boolean @default(true) @map("is_active")

  // B2B2C Distribution fields
  originProductId  String? @map("origin_product_id")
  originSupplierId String? @map("origin_supplier_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  category       Category?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  stockMovements StockMovement[]
  productTags    ProductTag[]

  // Product lineage relations
  originProduct   Product?  @relation("ProductLineage", fields: [originProductId], references: [id], onDelete: SetNull)
  derivedProducts Product[] @relation("ProductLineage")

  @@map("products")
}

model Tag {
  id          String   @id @default(uuid())
  name        String
  description String?
  color       String? // Cor hex para exibição (ex: "#3B82F6")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productTags ProductTag[]

  @@unique([userId, name])
  @@map("tags")
}

model ProductTag {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  tagId     String   @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@map("product_tags")
}

enum StockMovementType {
  entrada
  saida
  ajuste
  venda
  devolucao
}

model StockMovement {
  id            String            @id @default(uuid())
  productId     String            @map("product_id")
  type          StockMovementType
  quantity      Int
  previousStock Int               @map("previous_stock")
  newStock      Int               @map("new_stock")
  reason        String?
  reference     String?
  notes         String?           @db.Text
  createdAt     DateTime          @default(now()) @map("created_at")

  userId  String  @map("user_id")
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("stock_movements")
}

model Sale {
  id                String           @id @default(uuid())
  clientId          String           @map("client_id")
  userId            String           @map("user_id")
  itemDescription   String           @map("item_description")
  totalValue        Float            @map("total_value")
  totalInstallments Int              @map("total_installments")
  paymentFrequency  PaymentFrequency @map("payment_frequency")
  firstDueDate      DateTime         @map("first_due_date")
  totalPaid         Float            @default(0) @map("total_paid")
  saleDate          DateTime         @default(now()) @map("sale_date")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  installments Installment[]

  @@map("sales")
}

model Installment {
  id                String        @id @default(uuid())
  saleId            String        @map("sale_id")
  installmentNumber Int           @map("installment_number")
  amount            Float
  dueDate           DateTime      @map("due_date")
  status            PaymentStatus @default(pendente)
  paidDate          DateTime?     @map("paid_date")
  paidAmount        Float?        @map("paid_amount")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("installments")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now()) @map("created_at")

  clients    Client[]
  products   Product[]
  sales      Sale[]
  categories Category[]
  tags       Tag[]

  // B2B2C Distribution relations
  supplierRelationships BusinessRelationship[] @relation("SupplierRelations")
  resellerRelationships BusinessRelationship[] @relation("ResellerRelations")
  sentTransfers         StockTransfer[]        @relation("SentTransfers")
  receivedTransfers     StockTransfer[]        @relation("ReceivedTransfers")

  @@map("users")
}

model BusinessRelationship {
  id         String             @id @default(uuid())
  supplierId String             @map("supplier_id")
  resellerId String             @map("reseller_id")
  status     RelationshipStatus @default(PENDENTE)
  createdAt  DateTime           @default(now()) @map("created_at")
  acceptedAt DateTime?          @map("accepted_at")

  supplier User @relation("SupplierRelations", fields: [supplierId], references: [id], onDelete: Cascade)
  reseller User @relation("ResellerRelations", fields: [resellerId], references: [id], onDelete: Cascade)

  @@unique([supplierId, resellerId])
  @@map("business_relationships")
}

model StockTransfer {
  id         String         @id @default(uuid())
  supplierId String         @map("supplier_id")
  resellerId String         @map("reseller_id")
  status     TransferStatus @default(ENVIADO)
  items      Json // Array of {productId, quantity, name, costPrice, salePrice}
  notes      String?        @db.Text
  sentAt     DateTime       @default(now()) @map("sent_at")
  receivedAt DateTime?      @map("received_at")
  createdAt  DateTime       @default(now()) @map("created_at")

  supplier User @relation("SentTransfers", fields: [supplierId], references: [id], onDelete: Cascade)
  reseller User @relation("ReceivedTransfers", fields: [resellerId], references: [id], onDelete: Cascade)

  @@map("stock_transfers")
}
